<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç‰©å“æ£€æŸ¥</title>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <style>
    body { font-family: -apple-system, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background: #f9f9f9; }
    .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .check-item { margin: 12px 0; padding: 10px; background: #fff; border: 1px solid #eee; border-radius: 6px; display: flex; align-items: center; }
    .check-item input { width: 20px; height: 20px; margin-right: 12px; cursor: pointer; }
    .check-item label { flex: 1; cursor: pointer; font-size: 1rem; }
    canvas { border: 1px solid #ddd; width: 100%; height: 150px; background: #fff; border-radius: 4px; touch-action: none; }
    button { margin-top: 15px; padding: 12px; background: #2ecc71; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; font-size: 1rem; }
    button:active { background: #27ae60; }
    .clear-btn { background: #95a5a6; margin-top: 5px; padding: 5px; font-size: 0.8rem; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ“‹ å·¡æ£€ä»»åŠ¡</h2>
    <div id="item-info">æ­£åœ¨åŠ è½½ç‰©å“ä¿¡æ¯...</div>
    
    <form id="check-form">
      <div id="check-items"></div>
      <h3 style="margin-top:25px; border-top:1px solid #eee; padding-top:15px;">âœï¸ ç­¾å­—ç¡®è®¤</h3>
      <canvas id="signature-pad"></canvas>
      <button type="button" class="clear-btn" onclick="signaturePad.clear()">æ¸…é™¤é‡ç­¾</button>
      
      <button type="submit" id="submit-btn">æäº¤å·¡æ£€ç»“æœ</button>
    </form>
    <div id="result"></div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const itemId = urlParams.get('id');
    
    if (!itemId) {
      document.body.innerHTML = '<div style="text-align:center;padding:50px;"><h2>âŒ æ— æ•ˆçš„è®¿é—®é“¾æ¥</h2></div>';
    }

    const canvas = document.getElementById('signature-pad');
    const signaturePad = new SignaturePad(canvas);

    // è§£å†³ç§»åŠ¨ç«¯ç­¾åç¬”è§¦åç§»é—®é¢˜
    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext("2d").scale(ratio, ratio);
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // åŠ è½½ç‰©å“æ•°æ®
    fetch(`/api/items/${itemId}`)
      .then(res => res.json())
      .then(item => {
        document.getElementById('item-info').innerHTML = `
          <div style="background:#f1f3f5; padding:10px; border-radius:8px;">
            <strong>${item.name}</strong><br>
            <small style="color:#666;">ğŸ“ ä½ç½®ï¼š${item.location || 'é€šç”¨'}</small>
          </div>
        `;
        const container = document.getElementById('check-items');
        
        // å…³é”®ï¼šæ¸²æŸ“æ—¶è®°å½•é¡ºåº
        item.check_items.forEach((label, index) => {
          const div = document.createElement('div');
          div.className = 'check-item';
          div.innerHTML = `
            <input type="checkbox" id="check-${index}" class="inspection-cb">
            <label for="check-${index}">${label}</label>
          `;
          container.appendChild(div);
        });
      })
      .catch(err => {
        document.getElementById('item-info').innerHTML = '<p style="color:red">âŒ ç‰©å“åŠ è½½å¤±è´¥</p>';
      });

    // æäº¤é€»è¾‘
    document.getElementById('check-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      // if (signaturePad.isEmpty()) {
      //   alert('è¯·åœ¨æäº¤å‰å®Œæˆæ‰‹å†™ç­¾åï¼');
      //   return;
      // }

      const checkboxes = document.querySelectorAll('.inspection-cb');
      const resultsArray = Array.from(checkboxes).map(cb => cb.checked);

      const data = {
        item_id: itemId,
        check_results: resultsArray, // ç»“æœç¤ºä¾‹: [true, false, true, true, false]
        signature: signaturePad.toDataURL()
      };

      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.innerHTML = 'æ­£åœ¨æäº¤...';

      try {
        const res = await fetch('/api/inspections', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (!res.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
        const result = await res.json();
        
        if (result.success) {
          document.getElementById('result').innerHTML = `
            <div style="text-align:center; padding:30px;">
              <h2 style="color:#2ecc71;">âœ… æäº¤æˆåŠŸ</h2>
              <p>æœ¬æ¬¡å·¡æ£€è®°å½•å·²å®‰å…¨å½’æ¡£ã€‚</p>
            </div>`;
          document.getElementById('check-form').style.display = 'none';
        }
      } catch (err) {
        alert('æäº¤å¤±è´¥ï¼š' + err.message);
        btn.disabled = false;
        btn.innerHTML = 'é‡æ–°æäº¤';
      }
    });
  </script>
</body>
</html>
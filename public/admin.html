<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å·¡æ£€ç³»ç»Ÿç®¡ç†åå°</title>
  <style>
    /* åŸºç¡€æ ·å¼ä¿æŒä¸å˜ */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f8f9fa;
      color: #333;
      line-height: 1.6;
    }
    
    /* --- ç™»å½•é®ç½©å±‚æ ·å¼ --- */
    #loginOverlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(44, 62, 80, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(5px);
    }
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .login-box h2 { margin-bottom: 24px; color: #2c3e50; }
    .login-box input {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.3s;
    }
    .login-box input:focus { border-color: #3498db; }
    .login-box button {
      width: 100%;
      padding: 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    .login-box button:hover { background: #2980b9; }
    .login-error { color: #e74c3c; margin-top: 15px; font-size: 0.9rem; display: none; }

    /* --- åå°ä¸»ç•Œé¢ï¼ˆé»˜è®¤éšè—ï¼‰ --- */
    #adminContent { display: none; padding: 20px; }
    
    .container { max-width: 1000px; margin: 0 auto; }
    .section { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 30px; }
    h1 { text-align: center; margin-bottom: 30px; color: #2c3e50; }
    .section h2 { margin-bottom: 20px; color: #2980b9; font-size: 1.4rem; }

    /* è¡¨æ ¼æ ·å¼ */
    table { width: 100%; border-collapse: collapse; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    th, td { padding: 12px 16px; text-align: left; vertical-align: top; border-bottom: 1px solid #eee; }
    th { background: #f1f3f5; font-weight: 600; }
    tbody tr:hover { background-color: #f9f9f9; }
    .check-items-cell { max-width: 200px; word-break: break-word; }
    .time-links a { display: block; color: #2980b9; text-decoration: none; margin: 4px 0; font-size: 0.95rem; }
    .time-links a:hover { text-decoration: underline; }

    /* è¡¨å•æ§ä»¶ */
    .form-group { margin-bottom: 16px; }
    label { display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; }
    input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
    .check-items-container { border: 1px dashed #aaa; padding: 12px; border-radius: 6px; background: #f9f9f9; }
    .check-item-row { display: flex; gap: 10px; margin-bottom: 8px; }
    .btn-remove-check { background: #e74c3c; color: white; border: none; width: 30px; border-radius: 4px; cursor: pointer; }
    .btn-add-check { background: #2ecc71; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-top: 8px; }
    .btn-submit { background: #3498db; color: white; border: none; padding: 12px 24px; font-size: 1.1rem; border-radius: 6px; cursor: pointer; width: 100%; }
    .message { padding: 12px; margin-top: 16px; border-radius: 6px; text-align: center; }
    .message.success { background: #d4edda; color: #155724; }
    .message.error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>

  <div id="loginOverlay">
    <div class="login-box">
      <h2>ğŸ” ç®¡ç†å‘˜è®¤è¯</h2>
      <input type="password" id="adminPwdInput" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç " />
      <button onclick="handleLogin()">è¿›å…¥åå°</button>
      <div id="loginError" class="login-error">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
    </div>
  </div>

  <div id="adminContent">
    <div class="container">
      <h1>ğŸ”§ å·¡æ£€ç³»ç»Ÿç®¡ç†åå°</h1>

      <div class="section">
        <h2>ğŸ“¦ æ‰€æœ‰ç‰©å“åŠæ£€æŸ¥è®°å½•</h2>
        <div id="itemsContainer"><p>åŠ è½½ä¸­...</p></div>
      </div>

      <div class="section">
        <h2>â• æ·»åŠ æ–°ç‰©å“</h2>
        <form id="addItemForm">
          <div class="form-group">
            <label for="itemName">ç‰©å“åç§° *</label>
            <input type="text" id="itemName" required />
          </div>
          <div class="form-group">
            <label for="itemLocation">ä½ç½®</label>
            <input type="text" id="itemLocation" />
          </div>
          <div class="form-group">
            <label>æ£€æŸ¥é¡¹ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ *</label>
            <div class="check-items-container" id="checkItemsContainer">
              <div class="check-item-row">
                <input type="text" placeholder="ä¾‹å¦‚ï¼šå¤–è§‚æ˜¯å¦å®Œå¥½" required />
                <button type="button" class="btn-remove-check" disabled>âˆ’</button>
              </div>
            </div>
            <button type="button" class="btn-add-check" id="addCheckItem">+ æ·»åŠ æ£€æŸ¥é¡¹</button>
          </div>
          <button type="submit" class="btn-submit">ç”Ÿæˆç‰©å“ä¸äºŒç»´ç </button>
        </form>
        <div id="formMessage"></div>
        <div id="qrPreviewArea" style="margin-top: 24px; display: none;">
          <h3 style="margin: 20px 0 12px; color: #2c3e50;">ğŸ“± æœ€æ–°ç”Ÿæˆçš„äºŒç»´ç </h3>
          <div id="qrList" style="display: flex; flex-direction: column; gap: 20px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- 1. é…ç½®å‚æ•° ---
    const EXPIRE_TIME = 10 * 60 * 1000; // 10åˆ†é’Ÿç¼“å­˜

    async function handleLogin() {
      const pwdInput = document.getElementById('adminPwdInput');
      const pwd = pwdInput.value;
      
      const success = await verifyAndLoad(pwd);
      if (success) {
        // ç™»å½•æˆåŠŸï¼Œå­˜å…¥å¸¦æ—¶é—´æˆ³çš„ç¼“å­˜
        const session = {
          pwd: pwd,
          timestamp: new Date().getTime()
        };
        localStorage.setItem('admin_session', JSON.stringify(session));
        document.getElementById('loginError').style.display = 'none';
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    }

    // æ ¸å¿ƒéªŒè¯ä¸ç•Œé¢åˆ‡æ¢
    async function verifyAndLoad(pwd) {
      if (!pwd) return false;
      try {
        const res = await fetch(`/api/reports/monthly?pwd=${encodeURIComponent(pwd)}`);
        if (res.status === 403) return false;
        if (!res.ok) throw new Error();

        // éªŒè¯é€šè¿‡ï¼šéšè—é®ç½©ï¼Œæ˜¾ç¤ºå†…å®¹
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('adminContent').style.display = 'block';
        
        // æ‰§è¡Œæ•°æ®åŠ è½½ï¼ˆä¼ å…¥å½“å‰æœ‰æ•ˆå¯†ç ï¼‰
        loadItems(pwd); 
        return true;
      } catch (err) {
        return false;
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç¼“å­˜
    window.onload = () => {
      const cachedData = localStorage.getItem('admin_session');
      if (cachedData) {
        const session = JSON.parse(cachedData);
        const now = new Date().getTime();
        
        // æ£€æŸ¥æ˜¯å¦åœ¨ 10 åˆ†é’Ÿæœ‰æ•ˆæœŸå†…
        if (now - session.timestamp < EXPIRE_TIME) {
          verifyAndLoad(session.pwd);
          return;
        } else {
          localStorage.removeItem('admin_session'); // è¿‡æœŸæ¸…ç†
        }
      }
      // å¦‚æœæ²¡æœ‰æœ‰æ•ˆç¼“å­˜ï¼Œé¡µé¢ä¿æŒæ˜¾ç¤º loginOverlay
    };

    // --- 3. æ•°æ®åŠ è½½é€»è¾‘ (å·²ç§»é™¤æ‰€æœ‰ prompt) ---

    async function loadItems(pwd) {
      const container = document.getElementById('itemsContainer');
      
      // å¦‚æœè°ƒç”¨æ—¶æ²¡ä¼ å¯†ç ï¼Œå°è¯•ä»ç¼“å­˜æ‹¿ä¸€æ¬¡
      if (!pwd) {
        const session = JSON.parse(localStorage.getItem('admin_session') || '{}');
        pwd = session.pwd;
      }

      if (!pwd) {
        // å½»åº•æ²¡å¯†ç æ—¶ï¼Œæ˜¾ç¤ºç™»å½•é®ç½©å±‚
        document.getElementById('loginOverlay').style.display = 'flex';
        document.getElementById('adminContent').style.display = 'none';
        return;
      }

      try {
        container.innerHTML = '<p style="text-align:center; color:#666;">â³ æ­£åœ¨å®‰å…¨åŠ è½½æ•°æ®...</p>';

        // ç¬¬ä¸€æ­¥ï¼šè·å–ç‰©å“åˆ—è¡¨
        const res = await fetch(`/api/reports/monthly?pwd=${encodeURIComponent(pwd)}`);
        if (res.status === 403) {
          localStorage.removeItem('admin_session');
          location.reload(); // å¯†ç ä¸å¯¹ç›´æ¥é‡åˆ·å›åˆ°ç™»å½•é¡µ
          return;
        }
        
        const items = await res.json();

        // ç¬¬äºŒæ­¥ï¼šè·å–è®°å½•
        const insRes = await fetch(`/api/inspections/all`);
        const allInspections = insRes.ok ? await insRes.json() : [];

        // ç¬¬ä¸‰æ­¥ï¼šæ¸²æŸ“è¡¨æ ¼ (ä¿æŒä½ åŸæœ‰çš„æ¸²æŸ“é€»è¾‘)
        renderTableHTML(items, allInspections);

      } catch (err) {
        container.innerHTML = `<p style="color:red">åŠ è½½å¤±è´¥: ${err.message}</p>`;
      }
    }

    // æå–å‡ºçš„çº¯æ¸²æŸ“å‡½æ•°ï¼Œä¿æŒä½ åŸæœ¬çš„è¡¨æ ¼æ‹¼æ¥é€»è¾‘
    function renderTableHTML(items, allInspections) {
      const container = document.getElementById('itemsContainer');
      const insMap = {};
      allInspections.forEach(ins => {
        if (!insMap[ins.item_id]) insMap[ins.item_id] = [];
        insMap[ins.item_id].push(ins);
      });

      let html = `<table><thead><tr><th>ç‰©å“åç§°</th><th>ä½ç½®</th><th>æ£€æŸ¥é¡¹</th><th>30å¤©æ£€æŸ¥è¾¾æ ‡</th><th>æ£€æŸ¥æ—¶é—´</th><th>æ“ä½œ</th><th>äºŒç»´ç </th></tr></thead><tbody>`;

      items.forEach(item => {
        const checkItems = typeof item.check_items === 'string' ? JSON.parse(item.check_items) : item.check_items;
        const history = insMap[item.id] || [];
        
        // --- æ–°å¢ï¼šåˆ¤æ–­æœ€è¿‘ä¸€å‘¨æ˜¯å¦å…¨éƒ¨è¾¾æ ‡ ---
        const ONE_WEEK_MS = 30 * 24 * 60 * 60 * 1000;
        const now = new Date().getTime();
        
        // ç­›é€‰å‡ºæœ€è¿‘ 7 å¤©å†…çš„æ£€æŸ¥è®°å½•
        const recentIns = history.filter(h => (now - new Date(h.inspected_at).getTime()) < ONE_WEEK_MS);
        
        let complianceStatus = '<span style="color:#bdc3c7;">æœªæ£€æŸ¥</span>';
        if (recentIns.length > 0) {
            // æŒ‰æ—¶é—´æ’åºï¼Œå–æœ€è¿‘çš„ä¸€æ¡
            recentIns.sort((a, b) => new Date(b.inspected_at) - new Date(a.inspected_at));
            const latest = recentIns[0];
            
            // è§£ææ£€æŸ¥ç»“æœ
            const results = typeof latest.check_results === 'string' ? JSON.parse(latest.check_results) : latest.check_results;
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é¡¹éƒ½ä¸º true (æˆ–è€…å­—ç¬¦ä¸² "true")
            const allPassed = Object.values(results).every(val => val === true || val === "true");
            
            complianceStatus = allPassed 
                ? '<span style="color:#2ecc71;font-weight:bold;" title="æœ€è¿‘ä¸€å‘¨å·²æ£€æŸ¥ä¸”å…¨éƒ¨åˆæ ¼">âœ…å·²æ£€æŸ¥</span>' 
                : '<span style="color:#e74c3c;font-weight:bold;" title="æœ€è¿‘æ£€æŸ¥å­˜åœ¨ä¸åˆæ ¼é¡¹">âŒä¸åˆæ ¼</span>';
        }
        // ---------------------------------------

        let timeCell = '<span style="color:#bdc3c7;">â€”</span>';
        if (history.length > 0) {
            history.sort((a,b) => new Date(b.inspected_at) - new Date(a.inspected_at));
            const latest = history[0];
            timeCell = `<div><a href="/inspection.html?inspection_id=${latest.id}">${new Date(latest.inspected_at).toLocaleString()}</a></div>`;
            if (history.length > 1) {
                timeCell += `<div style="margin-top:4px;"><span onclick="toggleInspectionDetails(this)" style="cursor:pointer;color:#3498db;font-size:0.85em;">â–¶ å†å²è®°å½•(${history.length-1})</span></div>
                <div class="inspection-details" style="display:none;margin-top:5px;padding-left:10px;font-size:0.9em;border-left:2px solid #ddd;">
                  ${history.slice(1).map(h => `<div><a href="/inspection.html?inspection_id=${h.id}" style="color:#7f8c8d;text-decoration:none;">â€¢ ${new Date(h.inspected_at).toLocaleString()}</a></div>`).join('')}
                </div>`;
            }
        }

        // ä¿®æ”¹ HTML æ‹¼æ¥ï¼Œå¢åŠ  <td>${complianceStatus}</td>
        html += `<tr>
          <td><strong>${item.name}</strong></td>
          <td>${item.location || 'â€”'}</td>
          <td class="check-items-cell">${(checkItems||[]).slice(0,2).join(', ')}${checkItems.length>2?'...':''}</td>
          <td style="text-align:center;">${complianceStatus}</td> 
          <td class="time-links">${timeCell}</td>
          <td><button onclick="deleteItem('${item.id}', '${item.name}')" style="background:#e74c3c;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">åˆ é™¤</button></td>
          <td>
            <button onclick="toggleQrCode(this, '${item.id}')" style="background:#9b59b6;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">äºŒç»´ç </button>
            <div class="qr-expanded" style="display:none;margin-top:10px;"></div>
          </td>
        </tr>`;
      });
      container.innerHTML = html + `</tbody></table>`;
    }

    // è¾…åŠ©åŠŸèƒ½ä¿æŒä¸å˜...
    function toggleInspectionDetails(span) {
      const details = span.parentElement.nextElementSibling;
      const isHidden = details.style.display === 'none';
      details.style.display = isHidden ? 'block' : 'none';
      span.textContent = isHidden ? 'â–¼ æ”¶èµ·è®°å½•' : `â–¶ å†å²è®°å½•(${details.children.length})`;
    }
    function toggleQrCode(btn, itemId) {
      const div = btn.nextElementSibling;
      if (div.style.display === 'block') {
        div.style.display = 'none';
        btn.textContent = 'äºŒç»´ç ';
      } else {
        const url = `${window.location.origin}/index.html?id=${itemId}`;
        const qr = qrcode(0, 'M');
        qr.addData(url);
        qr.make();
        div.innerHTML = `<img src="${qr.createDataURL(4)}" style="width:100px;border:1px solid #ddd;" /><br><input readonly value="${url}" style="font-size:10px;width:100px;" onclick="this.select()"/>`;
        div.style.display = 'block';
        btn.textContent = 'å…³é—­';
      }
    }

    async function deleteItem(id, name) {
      if (!confirm(`ç¡®å®šåˆ é™¤ ${name}ï¼Ÿ`)) return;
      await fetch(`/api/items/${id}`, { method: 'DELETE' });
      loadItems();
    }

    // æ·»åŠ æ£€æŸ¥é¡¹è¡Œ
    document.getElementById('addCheckItem').onclick = () => {
      const row = document.createElement('div');
      row.className = 'check-item-row';
      row.innerHTML = `<input type="text" required /><button type="button" class="btn-remove-check" onclick="this.parentElement.remove()">âˆ’</button>`;
      document.getElementById('checkItemsContainer').appendChild(row);
    };

    // è¡¨å•æäº¤
    document.getElementById('addItemForm').onsubmit = async (e) => {
      e.preventDefault();
      const name = document.getElementById('itemName').value;
      const location = document.getElementById('itemLocation').value;
      const checkItems = Array.from(document.querySelectorAll('#checkItemsContainer input')).map(i => i.value);
      
      const res = await fetch('/api/items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, location, checkItems })
      });
      
      if (res.ok) {
        document.getElementById('formMessage').innerHTML = '<div class="message success">åˆ›å»ºæˆåŠŸ</div>';
        loadItems();
      }
    };
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«™ç‚¹ç®¡ç†åå°</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #f5f7f9; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        button { cursor: pointer; padding: 10px 18px; border-radius: 8px; border: none; font-weight: 500; transition: 0.2s; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-outline { background: white; border: 1px solid #ddd; color: #666; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; background: #f8f9fa; color: #666; font-weight: 600; }
        td { padding: 15px 12px; border-bottom: 1px solid #eee; }

        /* å¼¹çª—æ ·å¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 420px; max-height: 90vh; overflow-y: auto; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        label { font-size: 13px; color: #777; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-bar">
        <h1>ğŸ› ï¸ æ¶ˆé˜²å·¡æ£€ç®¡ç†åå°</h1>
        <button class="btn-primary" onclick="openModal('stationModal')">+ åˆ›å»ºæ–°å·¡æ£€ç«™</button>
    </div>

    <div class="card">
        <table id="stationTable">
            <thead>
                <tr>
                    <th>ç«™ç‚¹åç§°</th>
                    <th>åœ°ç†ä½ç½®</th>
                    <th>ç®¡ç†æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="stationList">
                <tr><td colspan="3" style="text-align:center;">æ­£åœ¨åŠ è½½ç«™ç‚¹æ•°æ®...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="stationModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ“ æ–°å¢å·¡æ£€ç«™ç‚¹</h3>
        <input type="text" id="stName" placeholder="ä¾‹å¦‚ï¼š1å·å®¿èˆæ¥¼ / å˜ç”µç«™A">
        <input type="text" id="stLoc" placeholder="è¯¦ç»†ä½ç½®è¯´æ˜">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-success" style="flex:1" onclick="saveStation()">ç¡®è®¤åˆ›å»º</button>
            <button class="btn-outline" style="flex:1" onclick="closeModal('stationModal')">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="deviceModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ§¯ æ·»åŠ ç­ç«å™¨åˆ° <span id="targetStationName" style="color:#3498db;"></span></h3>
        
        <label>è®¾å¤‡åç§°</label>
        <input type="text" id="devName" placeholder="å¦‚ï¼šABCå¹²ç²‰ç­ç«å™¨ 4kg">
        
        <label>å…·ä½“ä½ç½®</label>
        <input type="text" id="devLoc" placeholder="å¦‚ï¼šäºŒæ¥¼ä¸œä¾§æ¶ˆç«æ “æ—">
        
        <label>è§„æ ¼å‚æ•°</label>
        <input type="text" id="devSpecs" placeholder="å¦‚ï¼šMFZ/ABC4">
        
        <label>æœ‰æ•ˆæˆªæ­¢æ—¥æœŸ</label>
        <input type="date" id="devExpiry">
        
        <label>æ£€æŸ¥é¡¹ï¼ˆå¯å¢åˆ ï¼‰</label>
        <div id="checksContainer" style="margin-bottom:10px;">
            <!-- æ£€æŸ¥é¡¹å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <button type="button" class="btn-outline" style="font-size:14px; padding:4px 8px;" onclick="addCheckItem()">â• æ·»åŠ æ£€æŸ¥é¡¹</button>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-success" style="flex:1" onclick="saveDevice()">ä¿å­˜è®¾å¤‡</button>
            <button class="btn-outline" style="flex:1" onclick="closeModal('deviceModal')">è¿”å›</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    let activeStationId = null;
    const expandedStations = new Set(); // è®°å½•å“ªäº›ç«™ç‚¹å·²å±•å¼€

    // åŠ è½½æ‰€æœ‰ç«™ç‚¹
    async function loadStations() {
        try {
            const res = await fetch('/api/stations_all');
            if (!res.ok) throw new Error("è·å–æ•°æ®å¤±è´¥");
            const stations = await res.json();
            renderStations(stations);
        } catch (e) {
            document.getElementById('stationList').innerHTML = 
                `<tr><td colspan="3" style="color:red;text-align:center;">é”™è¯¯: ${e.message}</td></tr>`;
        }
    }

    // æ¸²æŸ“ç«™ç‚¹åˆ—è¡¨ï¼ˆå«å¯å±•å¼€è¡Œï¼‰
    function renderStations(stations) {
        const tbody = document.getElementById('stationList');
        if (stations.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#999;">æš‚æ— ç«™ç‚¹ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’åˆ›å»º</td></tr>';
            return;
        }

        let html = '';
        stations.forEach(st => {
            const isExpanded = expandedStations.has(st.id);
            html += `
                <tr>
                    <td>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="cursor:pointer;" onclick="toggleStation('${st.id}')">
                                ${isExpanded ? 'â–¼' : 'â–¶'}
                            </span>
                            <strong>${st.name}</strong>
                        </div>
                    </td>
                    <td><span style="color:#666;font-size:14px;">${st.location || 'æœªæ ‡æ³¨'}</span></td>
                    <td>
                        <button class="btn-outline" onclick="showStationQR('${st.id}', '${st.name}')">ğŸ” äºŒç»´ç </button>
                        <button class="btn-success" style="padding:8px 12px; font-size:13px;" onclick="openDeviceModal('${st.id}', '${st.name}')">+ å¢æ·»è®¾å¤‡</button>
                        <button class="btn-danger" style="padding:8px 12px; font-size:13px;" onclick="deleteStation('${st.id}')">ğŸ—‘ï¸ åˆ é™¤ç«™</button>
                    </td>
                </tr>
            `;
            
            // å±•å¼€è¡Œï¼šæ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨
            if (isExpanded) {
                html += `<tr id="expand-${st.id}"><td colspan="3" style="padding:0; background:#fafafa;">`;
                html += `<div id="devices-${st.id}" style="padding:15px;">åŠ è½½ä¸­...</div>`;
                html += `</td></tr>`;
            }
        });
        tbody.innerHTML = html;

        // åŠ è½½å·²å±•å¼€ç«™ç‚¹çš„è®¾å¤‡
        stations.forEach(st => {
            if (expandedStations.has(st.id)) {
                loadStationDevices(st.id);
            }
        });
    }

    // åˆ‡æ¢ç«™ç‚¹å±•å¼€/æ”¶èµ·
    async function toggleStation(stationId) {
        if (expandedStations.has(stationId)) {
            expandedStations.delete(stationId);
        } else {
            expandedStations.add(stationId);
        }
        const stationsRes = await fetch('/api/stations_all');
        const stations = await stationsRes.json();
        renderStations(stations);
    }

    // åŠ è½½æŸç«™ç‚¹çš„è®¾å¤‡åˆ—è¡¨ï¼ˆç”¨äºå±•å¼€åŒºåŸŸï¼‰
    async function loadStationDevices(stationId) {
        const container = document.getElementById(`devices-${stationId}`);
        if (!container) return;

        try {
            const res = await fetch(`/api/stations/${stationId}/devices_all`);
            const devices = await res.json();
            
            if (devices.length === 0) {
                container.innerHTML = '<em style="color:#999;">è¯¥ç«™ç‚¹æš‚æ— ç­ç«å™¨</em>';
                return;
            }

            let devHtml = `<div style="margin-bottom:10px;"><strong>å…± ${devices.length} ä¸ªç­ç«å™¨ï¼š</strong></div>`;
            devHtml += devices.map(dev => `
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; align-items:center;">
                    <div>
                        <strong>${dev.name}</strong><br>
                        <small style="color:#666;">${dev.location}</small>
                    </div>
                    <button class="btn-danger" style="padding:4px 8px; font-size:12px;" 
                            onclick="deleteDevice('${dev.id}', '${stationId}')">åˆ é™¤</button>
                </div>
            `).join('');
            container.innerHTML = devHtml;
        } catch (e) {
            container.innerHTML = `<span style="color:red;">åŠ è½½å¤±è´¥: ${e.message}</span>`;
        }
    }

    // åˆ é™¤ç«™ç‚¹
    async function deleteStation(stationId) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤æ­¤ç«™ç‚¹åŠæ——ä¸‹æ‰€æœ‰è®¾å¤‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) return;
        
        const res = await fetch(`/api/stations/${stationId}`, { method: 'DELETE' });
        if (res.ok) {
            expandedStations.delete(stationId); // æ”¶èµ·
            alert("ç«™ç‚¹å·²åˆ é™¤");
            loadStations();
        } else {
            const err = await res.json().catch(() => ({}));
            alert("åˆ é™¤å¤±è´¥ï¼š" + (err.error || "æœªçŸ¥é”™è¯¯"));
        }
    }

    // åˆ é™¤è®¾å¤‡
    async function deleteDevice(deviceId, stationId) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤æ­¤ç­ç«å™¨å—ï¼Ÿ")) return;
        
        const res = await fetch(`/api/devices/${deviceId}`, { method: 'DELETE' });
        if (res.ok) {
            alert("è®¾å¤‡å·²åˆ é™¤");
            loadStationDevices(stationId); // ä»…åˆ·æ–°è¯¥ç«™ç‚¹è®¾å¤‡
        } else {
            const err = await res.json().catch(() => ({}));
            alert("åˆ é™¤å¤±è´¥ï¼š" + (err.error || "æœªçŸ¥é”™è¯¯"));
        }
    }

    // ===== ä»¥ä¸‹æ˜¯ä½ åŸæœ‰çš„å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼Œä»…å¾®è°ƒï¼‰=====
    
    async function saveStation() {
        const name = document.getElementById('stName').value.trim();
        const location = document.getElementById('stLoc').value.trim();
        if(!name) return alert("è¯·å¡«å†™ç«™ç‚¹åç§°");

        const res = await fetch('/api/stations', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, location})
        });

        if(res.ok) {
            alert("ç«™ç‚¹åˆ›å»ºæˆåŠŸï¼");
            location.reload();
        }
    }

    function initCheckItems() {
        const container = document.getElementById('checksContainer');
        container.innerHTML = '';
        const defaults = ["å‹åŠ›è¡¨åœ¨ç»¿åŒº","å¤–è§‚æ— é”ˆèš€","å–·å˜´æ— å µå¡","é“…å°å®Œå¥½"];
        defaults.forEach(item => addCheckItem(item));
    }

    function addCheckItem(value = '') {
        const container = document.getElementById('checksContainer');
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.gap = '8px';
        div.style.marginBottom = '6px';
        div.innerHTML = `
            <input type="text" value="${value.replace(/"/g, '&quot;')}" 
                placeholder="è¾“å…¥æ£€æŸ¥å†…å®¹..." style="flex:1; padding:6px; border:1px solid #ccc; border-radius:4px;">
            <button type="button" class="btn-danger" style="width:30px; padding:0; font-size:16px;" 
                    onclick="this.parentElement.remove()">âˆ’</button>
        `;
        container.appendChild(div);
    }

    function getCheckItems() {
        const inputs = document.querySelectorAll('#checksContainer input[type="text"]');
        return Array.from(inputs).map(el => el.value.trim()).filter(text => text !== '');
    }

    function openDeviceModal(stationId, stationName) {
        activeStationId = stationId;
        document.getElementById('targetStationName').textContent = stationName;
        initCheckItems();
        openModal('deviceModal');
    }

    async function saveDevice() {
        const checkItems = getCheckItems();
        const payload = {
            name: document.getElementById('devName').value.trim(),
            location: document.getElementById('devLoc').value.trim(),
            specs: document.getElementById('devSpecs').value.trim(),
            expiry_date: document.getElementById('devExpiry').value,
            check_items: checkItems
        };

        if (!payload.name || !payload.location) {
            alert("è®¾å¤‡åç§°å’Œä½ç½®ä¸èƒ½ä¸ºç©ºï¼");
            return;
        }

        const res = await fetch(`/api/stations/${activeStationId}/devices`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            alert("è®¾å¤‡å·²æˆåŠŸæ·»åŠ åˆ°è¯¥ç«™ï¼");
            closeModal('deviceModal');
            // è‡ªåŠ¨å±•å¼€è¯¥ç«™ç‚¹ä»¥æ˜¾ç¤ºæ–°è®¾å¤‡
            expandedStations.add(activeStationId);
            loadStations();
        } else {
            const err = await res.json().catch(() => ({}));
            alert("ä¿å­˜å¤±è´¥ï¼š" + (err.error || "æœªçŸ¥é”™è¯¯"));
        }
    }

    function showStationQR(id, name) {
        const url = `${window.location.origin}/station_status.html?id=${id}`;
        const win = window.open("", "_blank", "width=350,height=480");
        win.document.write(`
            <div style="text-align:center; padding:30px; font-family:sans-serif;">
                <h2 style="margin:0;">${name}</h2>
                <p style="color:#666;">å…¨ç«™å·¡æ£€æ€»ç </p>
                <div id="qrcode" style="margin:25px auto; display:inline-block;"></div>
                <p style="font-size:11px; color:#999; word-break:break-all;">${url}</p>
                <button onclick="window.print()" style="margin-top:15px; padding:10px 20px; cursor:pointer;">æ‰“å°æ­¤ç </button>
            </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
            <script>new QRCode(document.getElementById("qrcode"), { text: "${url}", width: 220, height: 220 });<\/script>
        `);
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // å¯åŠ¨
    loadStations();
</script>
</body>
</html>
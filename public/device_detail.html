<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡è¯¦æƒ…åŠå·¡æ£€</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f7f6; margin: 0; padding: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .section-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; color: #333; display: flex; align-items: center; }
        
        /* 12å®«æ ¼æ ·å¼ */
        .history-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px; }
        .grid-item { text-align: center; padding: 10px 0; border-radius: 8px; font-size: 0.8rem; background: #eee; color: #999; }
        .grid-item.done { background: #2ecc71; color: white; }

        /* æ£€æŸ¥é¡¹ */
        .check-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .check-item input { width: 20px; height: 20px; margin-right: 12px; }

        /* ç­¾ååŒº */
        #sig-canvas { border: 1px dashed #ccc; background: #fafafa; width: 100%; height: 150px; touch-action: none; }
    </style>
</head>
<body>
    <div class="card">
        <div class="section-title">ğŸ“„ è®¾å¤‡æ¡£æ¡ˆ</div>
        <div id="deviceSpecs" style="font-size: 0.9rem; line-height: 1.6; color: #444;">åŠ è½½ä¸­...</div>
    </div>

    <div class="card">
        <div class="section-title">ğŸ“… å¹´åº¦å·¡æ£€ç»Ÿè®¡ (${new Date().getFullYear()}å¹´)</div>
        <div class="history-grid" id="historyGrid"></div>
    </div>

    <div class="card">
        <div class="section-title">âœï¸ æœ¬æœˆå·¡æ£€ç™»è®°</div>
        <div id="checkList"></div>
        <div style="margin-top:15px;">
            <p style="font-size: 0.9rem; color: #666;">è¯·åœ¨ä¸‹æ–¹ç­¾åï¼š</p>
            <canvas id="sig-canvas"></canvas>
            <button onclick="clearCanvas()" style="font-size: 0.8rem; margin-top: 5px;">é‡ç­¾</button>
        </div>
        <button onclick="submitCheck()" style="width: 100%; padding: 15px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-size: 1.1rem; margin-top: 20px; font-weight: bold;">æäº¤å·¡æ£€</button>
    </div>

    <div style="text-align: center; margin-bottom: 30px;">
        <button onclick="location.href='station_status.html?id='+stationId" style="background: none; border: none; color: #3498db; font-size: 1rem; text-decoration: underline;">è¿”å›ç«™ç‚¹æ€»è¡¨</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const deviceId = params.get('device_id');
        const stationId = params.get('station_id');
        let signaturePad;

        async function initPage() {
            // 1. åˆå§‹åŒ–ç­¾å
            const canvas = document.getElementById('sig-canvas');
            signaturePad = new SignaturePad(canvas);

            // 2. åŠ è½½æ•°æ®
            const year = new Date().getFullYear();
            const res = await fetch(`/api/devices/${deviceId}/history/${year}`);
            const data = await res.json();

            // æ¸²æŸ“æ¡£æ¡ˆ
            document.getElementById('deviceSpecs').innerHTML = `
                <b>åç§°ï¼š</b>${data.device.name}<br>
                <b>ä½ç½®ï¼š</b>${data.device.location}<br>
                <b>è§„æ ¼ï¼š</b>${data.device.specs}<br>
                <b>æœ‰æ•ˆæœŸè‡³ï¼š</b><span style="color:red">${data.device.expiry_date}</span>
            `;

            // æ¸²æŸ“12å®«æ ¼
            const historyMap = {};
            data.history.forEach(h => historyMap[h.month_str.split('-')[1]] = true);
            const grid = document.getElementById('historyGrid');
            for(let i=1; i<=12; i++) {
                const m = i < 10 ? `0${i}` : i;
                grid.innerHTML += `<div class="grid-item ${historyMap[m] ? 'done' : ''}">${i}æœˆ</div>`;
            }

            // æ¸²æŸ“æ£€æŸ¥é¡¹
            const checkList = document.getElementById('checkList');
            checkList.innerHTML = data.device.check_items.map((item, idx) => `
                <div class="check-item">
                    <input type="checkbox" id="chk${idx}">
                    <label for="chk${idx}">${item}</label>
                </div>
            `).join('');
        }

        async function submitCheck() {
            const results = [];
            document.querySelectorAll('#checkList input').forEach(chk => results.push(chk.checked));
            
            if (signaturePad.isEmpty()) return alert('è¯·å…ˆç­¾å');

            const payload = {
                device_id: deviceId,
                month_str: new Date().toISOString().slice(0, 7),
                check_results: results,
                signature: signaturePad.toDataURL()
            };

            const res = await fetch('/api/inspections', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert('æäº¤æˆåŠŸï¼');
                location.reload();
            }
        }

        function clearCanvas() { signaturePad.clear(); }
        
        initPage();
    </script>
</body>
</html>